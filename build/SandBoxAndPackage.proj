<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" DefaultTargets="Layout" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(RepoRoot)/Directory.Build.props" />

  <ItemGroup>
    <_MirrorOfRepoRootForTools Include="$(RepoRoot)/**/*.*" Exclude="$(RepoRoot)/$(SandBoxFolderName)/**/*.*;$(RepoRoot)/nuget/**/*.*;$(RepoRoot)/bin/**/*.*" />
    <_ArtifactsToPackage Include="$(RepoRoot)/bin/2/$(Rid)/**/*.*"/>
    <_ArtifactsToPackage Include="$(RepoRoot)/bin/Directory.Build.props"/>
    <_ToolsCacheToSpeedUp Include="$(RepoRoot)/$(RelativeCLIBuildBinaries)/**/*.*"/>
    <_NugetCacheToSpeedUp Include="$(RepoRoot)/.nuget/**/*.*" />
  </ItemGroup>

  <PropertyGroup>
    <SandBoxFolderName>sandBoxBin</SandBoxFolderName>
    <RelativeSandBoxPackageOutputFolder>$(SandBoxFolderName)/RelativeSandBoxPackageOutputFolder</RelativeSandBoxPackageOutputFolder>
  </PropertyGroup>

  <Target Name="SandBoxAndPackage" DependsOnTargets="PackageWithDocker;CopyPackageResult"/>

  <Target Name="PrepareSandBox" >
    <Copy
      SourceFiles="@(_MirrorOfRepoRootForTools)"
      DestinationFiles="@(_MirrorOfRepoRootForTools -> '$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/%(RecursiveDir)%(Filename)%(Extension)')"/>

    <Exec Command="sh -c 'cd $(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller) &amp;&amp; git clean -fxd'"/>

    <Copy
      SourceFiles="@(_ArtifactsToPackage)"
      DestinationFiles="@(_ArtifactsToPackage -> '$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/bin/2/$(Rid)/%(RecursiveDir)%(Filename)%(Extension)')"/>

    <Copy
      SourceFiles="@(_ToolsCacheToSpeedUp)"
      DestinationFiles="@(_ToolsCacheToSpeedUp -> '$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/$(RelativeCLIBuildBinaries)/%(RecursiveDir)%(Filename)%(Extension)')"/>

    <Copy
      SourceFiles="@(_NugetCacheToSpeedUp)"
      DestinationFiles="@(_NugetCacheToSpeedUp -> '$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/.nuget/%(RecursiveDir)%(Filename)%(Extension)')"/>

  </Target>

  <Target Name="PackageWithDocker" DependsOnTargets="PrepareSandBox">
    <Exec Command="$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/build.sh --configuration $(BuildConfiguration) --docker $(DockerFolder) --skip-prereqs /target:GenerateInstallersAndCopyOutOfSandBox /p:RelativeSandBoxPackageOutputFolder=$(RelativeSandBoxPackageOutputFolder)"/>
  </Target >

  <Target Name="CopyPackageResult">
    <ItemGroup>
      <_SandboxPackageResultFiles Include="$(RepoRoot)/$(SandBoxFolderName)/$(LinuxDistrosNeedNativeInstaller)/$(RelativeSandBoxPackageOutputFolder)/**/*.*"/>
    </ItemGroup>
    <Copy
      SourceFiles="@(_SandboxPackageResultFiles)"
      DestinationFolder="$(InstallerOutputDirectory)/%(RecursiveDir)"/>
  </Target >
</Project>